{{- define "kong.deployment" -}}
apiVersion: apps/v1
kind: Deployment
metadata:
  name: {{ template "kong.fullname" . }}-controller
  namespace:  {{ template "kong.namespace" . }}
  # TODO ALT 921 same thing with selector labels
  labels:
    {{- include "kong.metaLabels" . | nindent 4 }}
    app.kubernetes.io/component: controller
    {{- range $key, $value := .Values.ingressController.deployment.labels }}
    {{ $key }}: {{ include "kong.renderTpl" (dict "value" $value "context" $) | quote | nindent 4 }}
    {{- end }}
  {{- if .annotations }}
  annotations:
  {{- range $key, $value := .Values.ingressController.deployment.annotations }}
    {{ $key }}: {{ include "kong.renderTpl" (dict "value" $value "context" $) | quote }}
  {{- end }}
  {{- end }}
spec:
  replicas: {{ .Values.ingressController.deployment.replicaCount }}
  selector:
    matchLabels:
{{ .pre.deployment.controllerSelectorMatchLabels | nindent 6 -}}
  {{- if .Values.ingressController.deployment.updateStrategy }}
  strategy:
{{ toYaml .Values.ingressController.deployment.updateStrategy | indent 4 }}
  {{- end }}
  {{- if .Values.ingressController.deployment.minReadySeconds }}
  minReadySeconds: {{ .Values.ingressController.deployment.minReadySeconds }}
  {{- end }}

  template:
    metadata:
      annotations:
        # TODO ALT 921 complicated. we generate a single SA from .deployment.kong.serviceAccount configuration. we could, but probably
        # shouldn't share it
        {{- if (and (not .Values.ingressController.deployment.pod.automountServiceAccountToken) (or .pre.deployment.serviceAccount.create .pre.deployment.serviceAccount.name)) }}
        kuma.io/service-account-token-volume: {{ template "kong.serviceAccountTokenName" . }}
        {{- end }}
        {{- if .Values.ingressController.deployment.pod.annotations }}
        {{- range $key, $value := .Values.ingressController.deployment.pod.annotations }}
        {{ $key }}: {{ include "kong.renderTpl" (dict "value" $value "context" $) | quote }}
        {{- end }}
        {{- end }}
      labels:
        {{- .pre.pod.labels | nindent 8 }}
        app.kubernetes.io/component: {{ .pre.pod.component }}
        app: {{ .pre.pod.app }}
        version: {{ .pre.pod.versionLabel | quote }}
        {{- if .Values.ingressController.deployment.pod.labels }}
        {{ include "kong.renderTpl" (dict "value" .Values.ingressController.deployment.pod.labels "context" $) | nindent 8 }}
        {{- end }}
    spec:
      {{- if .Values.ingressController.deployment.pod.hostNetwork }}
      hostNetwork: true
      {{- end }}
      {{- if .Values.ingressController.deployment.pod.priorityClassName }}
      priorityClassName: "{{ .Values.ingressController.deployment.pod.priorityClassName }}"
      {{- end }}
      {{- if or .pre.deployment.serviceAccount.create .pre.deployment.serviceAccount.name }}
      serviceAccountName: {{ .pre.deployment.serviceAccountName }}
      {{- end }}
      {{- if (and (or .pre.deployment.serviceAccount.create .pre.deployment.serviceAccount.name) .pre.deployment.serviceAccount.automountServiceAccountToken) }}
      automountServiceAccountToken: true
      {{- else }}
      automountServiceAccountToken: false
      {{ end }}
      {{- if .Values.ingressController.deployment.pod.container.image.pullSecrets }}
      # NOTE 921 this is out of place, but the rest of .image _does_ live
      # inside the container, so probably just keep it there, rather than
      # separating into .pod.imagePullSecrets
      imagePullSecrets:
      {{- range .Values.ingressController.deployment.pod.container.image.pullSecrets }}
        - name: {{ . }}
      {{- end }}
      {{- end }}
      {{- if .Values.ingressController.deployment.pod.hostAliases }}
      hostAliases:
        {{- toYaml .Values.ingressController.deployment.pod.hostAliases | nindent 6 }}
      {{- end}}
      {{- if .Values.ingressController.deployment.dnsPolicy }}
      dnsPolicy: {{ .Values.ingressController.deployment.pod.dnsPolicy | quote }}
      {{- end }}
      {{- if .Values.ingressController.deployment.pod.dnsConfig }}
      dnsConfig:
{{ toYaml .Values.ingressController.deployment.pod.dnsConfig | indent 8 }}
      {{- end }}
      containers:
{{ .pre.pod.container | nindent 8 }}
{{- if .Values.ingressController.deployment.pod.sidecarContainers }}
{{- toYaml .Values.ingressController.deployment.pod.sidecarContainers | nindent 8 }}
{{- end }}
    {{- if .Values.ingressController.deployment.pod.affinity }}
      affinity:
{{ toYaml .Values.ingressController.deployment.pod.affinity | indent 8 }}
    {{- end }}
    {{- if .Values.ingressController.deployment.pod.topologySpreadConstraints }}
      topologySpreadConstraints:
{{ toYaml .Values.ingressController.deployment.pod.topologySpreadConstraints | indent 8 }}
    {{- end }}
      securityContext:
      {{- .Values.ingressController.deployment.pod.securityContext | toYaml | nindent 8 }}
    {{- if .Values.ingressController.deployment.pod.nodeSelector }}
      nodeSelector:
{{ toYaml .Values.ingressController.deployment.pod.nodeSelector | indent 8 }}
    {{- end }}
      terminationGracePeriodSeconds: {{ .Values.ingressController.deployment.pod.terminationGracePeriodSeconds }}
    {{- if .Values.ingressController.deployment.pod.tolerations }}
      tolerations:
{{ toYaml .Values.ingressController.deployment.pod.tolerations | indent 8 }}
    {{- end }}
      volumes:
      {{- .pre.deployment.volumes | nindent 8 -}}
      {{- .pre.deployment.userVolumes | nindent 8 -}}

{{- end -}} {{/* end kong.deployment */}}

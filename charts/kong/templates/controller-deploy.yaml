{{- if .Values.deployment.controller.enabled }}
{{- $deployConfig := dict -}}
{{- $deployConfig = (mustMerge $deployConfig .Values.deployment.controller) -}}
{{- $deployPreRender := dict -}} {{/* collection of values rendered from includes, so that there's no risk of colliding with things from the merge */}}
{{- $podPreRender := dict -}}

{{- $_ := set $deployPreRender "name" (printf "%s-%s" (include "kong.fullname" .) "controller") -}}
{{- $_ := set $deployPreRender "namespace" (include "kong.namespace" .) -}}
# TODO 921 combine with .deployment.controller.labels.
# unsure how the types work out here--kong.metaLabels produces YAML output, and I'm not sure if we can
# just concat them as strings or what. can maybe ignore .deployment.controller.labels--it wasn't
# included in the past and we instead set extraLabels on EVERYTHING. that's apparently sufficient for
# user needs (there's been no request to provide separate per-resource labels here), but incongruous
# with how we handle annotations
{{- $_ := set $deployPreRender "labels" (include "kong.metaLabels" .) -}}
# TODO 921 this needs changes to the helper template since we'll need to point to two different sets of pods.
# in ingress chart this is relying on different fullnames. can't simply format since there multiple keys,
# need to pass a suffix to the helper
{{- $_ := set $deployPreRender "selectorMatchLabels" (include "kong.selectorLabels" .) -}}
{{- $_ := set $deployPreRender "serviceAccountTokenName" (include "kong.serviceAccountTokenName" .) -}}
{{- $_ := set $deployPreRender "serviceAccountName" (include "kong.serviceAccountName" .) -}}
# TODO 921 this helper needs to be split somehow. as-is it includes things that are only useful for one
# pod or the other, e.g. the controller does not need the prefix dir. as a placeholder, including
# unnecessary volumes doesn't really hurt us
{{- $_ := set $deployPreRender "volumes" (include "kong.volumes" .) -}}
{{- $_ := set $deployPreRender "userVolumes" (include "kong.userDefinedVolumes" .) -}}

# TODO 921 ditto the deploy labels todo
{{- $_ := set $podPreRender "labels" (include "kong.metaLabels" .) -}}
{{- $_ := set $podPreRender "name" (printf "%s-%s" (include "kong.fullname" .) "controller") -}}
{{- $_ := set $podPreRender "versionLabel" .Chart.AppVersion -}}

# TODO 921 probably use the same pre pattern for this
{{- $containerConfig := .Values.deployment.controller.pod.container -}}
{{- $containerPre := dict -}}
{{- $_ := set $containerPre "admissionWebhook" .Values.admissionWebhook -}}
{{- $_ := set $containerPre "env" (include "kong.ingressController.env" .) -}}
{{- $_ := set $containerPre "disableProbes" .Values.ingressController.disableProbes -}}
{{- $_ := set $containerPre "adminApi" .Values.ingressController.adminApi -}}
{{- $_ := set $containerPre "serviceAccount" .Values.deployment.controller.pod.serviceAccount -}}
{{- $_ := set $containerPre "serviceAccountTokenName" (include "kong.serviceAccountTokenName" .) -}}
{{- $_ := set $containerPre "serviceAccountName" (include "kong.serviceAccountName" .) -}}
{{- $_ := set $containerConfig "pre" $containerPre -}}

{{- $_ := set $podPreRender "container" (include "kong.controller-container-new" $containerConfig ) -}}

{{- $preRender := dict -}}
{{- $_ := set $preRender "deployment" $deployPreRender -}}
{{- $_ := set $preRender "pod" $podPreRender -}}
{{- $_ := set $deployConfig "pre" $preRender -}} # TODO 921 maybe think of a better key name

{{- template "kong.deployment" $deployConfig -}}
{{- end -}}

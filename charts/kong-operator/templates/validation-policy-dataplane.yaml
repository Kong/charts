# This file is auto-generated by KO's hack/generators/validating-policy/main.go generator.
{{- if and (.Capabilities.APIVersions.Has "admissionregistration.k8s.io/v1/ValidatingAdmissionPolicy") (.Capabilities.APIVersions.Has "admissionregistration.k8s.io/v1/ValidatingAdmissionPolicyBinding") -}}
{{- if .Values.global.validatingPolicies.dataplanePorts.enabled }}
apiVersion: admissionregistration.k8s.io/v1
kind: ValidatingAdmissionPolicy
metadata:
  name: ports.dataplane.gateway-operator.konghq.com
spec:
  matchConstraints:
    resourceRules:
    - apiGroups:
      - gateway-operator.konghq.com
      apiVersions:
      - v1beta1
      operations:
      - CREATE
      - UPDATE
      resources:
      - dataplanes
  validations:
  - expression: |
      variables.isNotValidatable ||
      variables.envPortMaps == null ||
      variables.ingressPorts.all(p, string(p.targetPort) in variables.portMapPorts)
    messageExpression: '''Each port from spec.network.services.ingress.ports has to
      have an accompanying port in KONG_PORT_MAPS env'''
    reason: Invalid
  - expression: |
      variables.isNotValidatable ||
      variables.envProxyListen == null ||
      variables.ingressPorts.all(p, string(p.targetPort) in variables.proxyListenPorts)
    messageExpression: '''Each port from spec.network.services.ingress.ports has to
      have an accompanying port in KONG_PROXY_LISTEN env'''
    reason: Invalid
  variables:
  - expression: object.spec.network.services.ingress.ports
    name: ingressPorts
  - expression: object.spec.deployment.podTemplateSpec
    name: podTemplateSpec
  - expression: |
      variables.podTemplateSpec.spec.containers.filter(c, c.name == 'proxy')
    name: proxyContainers
  - expression: |
      variables.proxyContainers.size() > 0 ?
        variables.proxyContainers[0] :
        null
    name: proxyContainer
  - expression: |
      variables.proxyContainer != null && has(variables.proxyContainer.env) ?
        variables.proxyContainer.env.filter(e, e.name == "KONG_PORT_MAPS") : []
    name: envFilteredPortMaps
  - expression: |
      variables.proxyContainer != null && has(variables.proxyContainer.env) ?
        variables.proxyContainer.env.filter(e, e.name == "KONG_PROXY_LISTEN") : []
    name: envFilteredProxyListen
  - expression: |
      variables.envFilteredPortMaps.size() > 0 ? variables.envFilteredPortMaps[0].value : null
    name: envPortMaps
  - expression: |
      variables.envFilteredProxyListen.size() > 0 ? variables.envFilteredProxyListen[0].value : null
    name: envProxyListen
  - expression: |
      !has(object.spec.network) ||
      !has(object.spec.network.services) ||
      !has(object.spec.network.services.ingress) ||
      !has(object.spec.network.services.ingress.ports) ||
      variables.proxyContainer == null ||
      !has(variables.proxyContainer.env)
    name: isNotValidatable
  - expression: |
      variables.envProxyListen != null ?
      variables.envProxyListen.split(',').map(s,
        s.trim().split(' ')[0]
      ).map(addr,
        addr.substring(addr.lastIndexOf(':') + 1)
      ) : []
    name: proxyListenPorts
  - expression: |
      variables.envPortMaps != null ?
      variables.envPortMaps.split(',').map(s,
        s.substring(s.lastIndexOf(':') + 1).trim()
      ) : []
    name: portMapPorts
---
apiVersion: admissionregistration.k8s.io/v1
kind: ValidatingAdmissionPolicyBinding
metadata:
  name: binding-ports.dataplane.gateway-operator.konghq.com
spec:
  policyName: ports.dataplane.gateway-operator.konghq.com
  validationActions:
  - Deny

{{- end -}}

{{- end -}}
